<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8"/>
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge"/>
  <title>모집(mo.zip) - 멤버모집 작성</title>
  <!-- font awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <!-- 직접구현한 CSS -->
  <link rel="stylesheet" th:href="@{/css/reset.css}"/>
  <link rel="stylesheet" th:href="@{/css/common.css}"/>
  <link rel="stylesheet" th:href="@{/css/index.css}"/>
  <link rel="stylesheet" th:href="@{/css/create.css}"/>
  <!-- js -->
  <!-- jquery -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
          crossorigin="anonymous"></script>

  <script defer th:src="@{/js/dynamicSkills.js}"></script>
  <script th:src="@{/js/common.js}"></script>
  <script th:src="@{/js/03yoonji.js}"></script>
  <!-- favicon -->
  <link rel="icon" th:href="@{/img/favicon.ico}">
</head>
<body>
<header id="header">
  <th:block th:replace="~{fragment/header}"></th:block>
</header>
<main>
  <div class="wrap flex">
    <div class="rc-input">
      <form id="editShow">
        <input name="id" style="display: none" th:value="${project.getId()}"/>
        <select name="projectType" class="project-type">
          <option th:value="'사이드 프로젝트'" th:text="'사이드 프로젝트'" th:selected="${project.getProjectType() == '사이드 프로젝트'}"></option>
          <option th:value="'모집/스터디'" th:text="'모집/스터디'" th:selected="${project.getProjectType() == '모집/스터디'}"></option>
        </select>
        <input class="rc-title" type="text" id="projectName" name="projectName" th:value="*{project.getProjectName()}" placeholder="주제를 입력하세요" maxlength="50">
        <div class="cont-flex">
          <div>
            <label class="s-title">모집인원</label>
            <select name="recruitCount">
              <option th:value="0" th:selected="${project.getRecruitCount() == 0}">인원 미정</option>
              <option th:value="1" th:selected="${project.getRecruitCount() == 1}">1명</option>
              <option th:value="2" th:selected="${project.getRecruitCount() == 2}">2명</option>
              <option th:value="3" th:selected="${project.getRecruitCount() == 3}">3명</option>
              <option th:value="4" th:selected="${project.getRecruitCount() == 4}">4명</option>
              <option th:value="5" th:selected="${project.getRecruitCount() == 5}">5명</option>
              <option th:value="6" th:selected="${project.getRecruitCount() == 6}">6명</option>
              <option th:value="7" th:selected="${project.getRecruitCount() == 7}">7명</option>
              <option th:value="8" th:selected="${project.getRecruitCount() == 8}">8명</option>
              <option th:value="9" th:selected="${project.getRecruitCount() == 9}">9명</option>
            </select>
          </div>
          <div>
            <label class="s-title">진행방식</label>
            <select name="projectProcess">
              <option th:value="'온라인'" th:selected="${project.getProjectProcess() == '온라인'}">온라인</option>
              <option th:value="'오프라인'" th:selected="${project.getProjectProcess() == '오프라인'}">오프라인</option>
              <option th:value="'온/오프라인'" th:selected="${project.getProjectProcess() == '온/오프라인'}">온/오프라인</option>
            </select>
          </div>
        </div>
        <div class="cont-flex">
          <div>
            <label class="s-title">참여시간</label>
            <select name="projectTime">
              <option th:value="1" th:selected="${project.getProjectTime() == 1}">매주 4시간 이하</option>
              <option th:value="2" th:selected="${project.getProjectTime() == 2}">매주 4 ~ 10시간</option>
              <option th:value="3" th:selected="${project.getProjectTime() == 3}">매주 10시간 이상</option>
            </select>
          </div>
          <div>
            <label class="s-title">수행목적</label>
            <select name="projectPurpose">
              <option th:value="'포트폴리오/직무 역량 강화'" th:selected="${project.getProjectPurpose()== '포트폴리오/직무 역량 강화'}"> 포트폴리오/직무 역량 강화</option>
              <option th:value="'창업/수익 창출'" th:selected="${project.getProjectPurpose()== '창업/수익 창출'}">창업/수익 창출</option>
              <option th:value="'재미/네트워킹'" th:selected="${project.getProjectPurpose()== '재미/네트워킹'}">재미/네트워킹</option>
            </select>
          </div>
        </div>
        <div class="cont-flex">
          <div>
            <label for="startDate" class="s-title">시작날짜</label>
            <input type="date" id="startDate" name="createdChangeAt" th:value="${project.createdChangeAt != null ? project.createdChangeAt : ''}">
          </div>
          <div>
            <label for="endDate" class="s-title">종료날짜</label>
            <input type="date" id="endDate" name="modifiedChangeAt" th:value="${project.modifiedChangeAt != null ? project.modifiedChangeAt : ''}">
          </div>
        </div>
        <div class="cont-flex">
          <div>
            <label for="role" class="s-title">모집분야</label>
            <div class="select-programs" id="role-container">
              <!--아이콘 들어가는 곳-->
            </div>
            <select id="role">
              <option value="all">전체</option>
              <option value="프론트엔드">프론트엔드</option>
              <option value="백엔드">백엔드</option>
              <option value="디자인">디자인</option>
              <option value="기획">기획</option>
            </select>
          </div>
          <div>
            <label for="skill" class="s-title">기술스택</label>
            <div class="select-programs" id="skill-container">
            </div>
            <select id="skill">
              <option value="" selected disabled hidden>기술스택</option>
              <option value="AWS">AWS</option>
              <option value="Docker">Docker</option>
              <option value="Figma">Figma</option>
              <option value="Flutter">Flutter</option>
              <option value="Git">Git</option>
              <option value="Java">Java</option>
              <option value="JavaScript">JavaScript</option>
              <option value="Jest">Jest</option>
              <option value="Kotlin">Kotlin</option>
              <option value="MongoDb">MongoDb</option>
              <option value="MySQL">MySQL</option>
              <option value="Nodejs">Nodejs</option>
              <option value="php">php</option>
              <option value="Python">Python</option>
              <option value="React">React</option>
              <option value="ReactNative">ReactNative</option>
              <option value="Spring">Spring</option>
              <option value="Svelte">Svelte</option>
              <option value="TypeScript">TypeScript</option>
              <option value="Vue">Vue</option>
            </select>
          </div>
        </div>
        <div class="rc-project-info">
          <p class="s-title">소개</p>
          <textarea cols="40" rows="15" th:text="${project.getProjectInfo()}" name="projectInfo" placeholder="프로젝트 소개글을 작성하세요."></textarea>
        </div>
        <button class="open-modal btn-write" type="button" id="mypage-button">수정하기</button>
        <!-- 모달창 -->
        <div class="modal-bg"></div>
        <div class="modal">
          <div class="modal-header">
            <a href="#" class="close-modal"><i class="fa-solid fa-xmark"></i></a>
          </div>
          <h3>모집글을 수정하시겠습니까?</h3>
          <div class="button-wrap">
            <button class="close-modal">돌아가기</button>
            <!-- TODO: <button class="submit-modal" type="submit"> 백엔드 연결 후 수정 -->
            <button class="submit-modal">
              수정완료
            </button>
          </div>
        </div>
      </form>
    </div>
    <div class="rc-info">

    </div>
  </div>
  <script>
    document.querySelector('.submit-modal').addEventListener("click", function () {
      event.preventDefault(); // form 전송 막는 코드
      let formData = $("#editShow").serializeArray();
      let jsonData = {};

      $(formData).each(function (index, obj) {
        jsonData[obj.name] = obj.value;
      })

      jsonData.skills = [];

      document.querySelectorAll(".selected-skill").forEach((skill) => {
        jsonData.skills.push(skill.id);
      })

      jsonData.recruitRole = [];
      document.querySelectorAll(".selected-role").forEach((role) => {
        jsonData.recruitRole.push(role.id);
      })

      let projectId = jsonData.id;

        $.ajax({
          type: "PATCH",
          url: `/api/show/${projectId}`,
          data: JSON.stringify(jsonData),
          contentType: "application/json; charset=utf-8",
          dataType: "json"
        }).done(res => { // HTTP 상태 코드 200번대일 때 호출됨
          console.log("통신성공", res);
          alert("데이터 수정완료!");
          let projectId = res.data;
          window.location.assign(`/project/show/${projectId}`);
        }).fail(error => { // HTTP 상태 코드 200번대가 아닐 때 호출됨
          alert("게시글 수정을 실패했습니다. 다시 시도해주세요."); // 서버에서 반환된 메시지 대신 고정 메시지 표시
      });
    })

    // // 프로젝트 주제(textarea) : 1줄만 쓰게 제한
    // document.getElementById('subject').addEventListener('keydown', function (event) {
    //   if (event.key === 'Enter') {
    //     event.preventDefault();
    //   }
    // });
    //
    // // 프로젝트 주제(textarea) 입력 칸 : 20자 글자 제한
    // document.getElementById('subject').addEventListener('input', function () {
    //   if (this.value.length > 20) {
    //     this.value = this.value.slice(0, 20);
    //   }
    // });

    document.querySelector(".open-modal").addEventListener("click", function () {
      document.querySelector(".modal-bg").classList.add("visible");
      document.querySelector(".modal").classList.add("visible");
    });

    document.querySelector(".close-modal").addEventListener("click", function () {
      document.querySelector(".modal-bg").classList.remove("visible");
      document.querySelector(".modal").classList.remove("visible");
    });

    document.addEventListener("click", function (event) {
      if (
              !event.target.closest(".modal, .open-modal")
      ) {
        document.querySelector(".modal").classList.remove("visible");
        document.querySelector(".modal-bg").classList.remove("visible");
        document.body.classList.remove("modal-open");
      }
    });
    
    // 프로젝트 주제(textarea) : 1줄만 쓰게 제한
    document.getElementById('subject').addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        event.preventDefault();
      }
    });

    // 프로젝트 주제(textarea) 입력 칸 : 20자 글자 제한
    document.getElementById('subject').addEventListener('input', function () {
      if (this.value.length > 20) {
        this.value = this.value.slice(0, 20);
      }
    });

    // 프로젝트 자랑 수정
    document.addEventListener('DOMContentLoaded', function () {
      const stackSelect = document.getElementById('stack');
      const memberSkills = Array.from(document.querySelectorAll("#stack-container .selected-item .projectSkill")).map(item => item.textContent.trim());
      const removedOptions = [];

      const options = Array.from(stackSelect.options);
      memberSkills.forEach(skill => {
        const optionToRemove = options.find(option => option.text.trim() === skill);
        if (optionToRemove) {
          removedOptions.push(optionToRemove.cloneNode(true));
          stackSelect.removeChild(optionToRemove);
        }
      });


      // 수정폼 클릭 이벤트
      const submitButton = document.getElementById("mypage-button");

      submitButton.addEventListener("click", function (event) {
        event.preventDefault();
        sendFormData();
        // if (validateForm()) {
        //     // 유효성 검사를 통과하면 AJAX 요청
        //
        // }
      });

      // stackSelect.addEventListener("change", () => {
      //     handleStackSelectChange(stackSelect, "stack-container");
      // });
    });

    function sendFormData() {
      let formData = $("#editShow").serializeArray();
      console.log(formData);
      let projectName = document.querySelector("#projectName").value;
      let startDate = document.querySelector("#startDate").value;
      let endDate = document.querySelector("#endDate").value;
      let projectTime = document.querySelector("#projectTime").value;
      let projectInfo = document.querySelector("#projectInfo").value;

      let jsonData = {};
      jsonData.prjectName = projectName;
      jsonData.startDate = startDate;
      jsonData.endDate = endDate;
      jsonData.projectTime = projectTime;
      jsonData.projectInfo = projectInfo;

      let skills = [];

      document.querySelectorAll(".projectSkill").forEach(item => {
        skills.push(item.textContent);
      });

      jsonData.skills = skills;

      console.log(jsonData);

      $.ajax({
        type: "PATCH",
        url: "/api/show/" + projectId,
        contentType: "application/json; charset=utf-8",
        dataType: "json"
      }).done(res => { // HTTP 상태 코드 200번대일 때 호출됨
        console.log("성공:", res);
        alert("게시글이 성공적으로 수정되었습니다."); // 서버에서 반환된 메시지 표시
        window.location.replace(`/project/show`);
      }).fail(error => { // HTTP 상태 코드 200번대가 아닐 때 호출됨
        alert("게시글 수정을 실패했습니다. 다시 시도해주세요."); // 서버에서 반환된 메시지 대신 고정 메시지 표시
      });
    }
  </script>
</main>
</body>
</html>
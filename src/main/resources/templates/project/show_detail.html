<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>모집(mo.zip) - 프로젝트 자랑 상세</title>
  <!-- css / font -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/variable/pretendardvariable.min.css"/>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css"/>
  <link rel="stylesheet" th:href="@{/css/reset.css}">
  <link rel="stylesheet" th:href="@{/css/common.css}">
  <link rel="stylesheet" th:href="@{/css/detail.css}">
  <!-- js -->
  <script src="https://code.jquery.com/jquery-3.7.1.js" integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="
          crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
  <script th:src="@{/js/index.js}"></script>
  <script th:src="@{/js/common.js}"></script>
  <!-- favicon -->
  <link rel="icon" th:href="@{/img/favicon.ico}">
</head>
<body>
<header id="header">
  <th:block th:replace="~{fragment/header}"></th:block>
</header>
<!-- main -->
<main>
  <div class="wrap flex">
    <div class="content show">
      <div class="main-contents">
        <div class="title-wrap">
          <span class="pj-type pj" th:classappend="${showDetail.getProjectType() == '사이드 프로젝트'? 'pj' : 'study'}"
                th:text="${showDetail.getProjectType()}">사이드 프로젝트</span>
          <p class="title">
            <th:block th:text="${showDetail.getProjectName()}">엘리스 SW 4기 모집합니다!</th:block>
          </p>
        </div>
        <div class="info-wrap">
          <ul class="count">
            <li th:text="${showDetail.getCreatedAt()}">2024년 4월 30일</li>
            <li>
              <i class="fa-regular fa-thumbs-up"></i>
              <span id="topLiveLike">
                <th:block th:text="${showDetail.getLikes()} + '개'"> 4개</th:block>
              </span>
            </li>
            <li><i class="fa-solid fa-eye"></i><th:block th:text="${showDetail.getViews()} + '회'"> 28회</th:block></li>
          </ul>
          <a href="" class="share-Btn"><i class="fa-solid fa-share-nodes"></i>공유하기</a>
        </div>
        <!-- <input type="text" id="urlInput" value=""> -->
        <!-- <div class="copy-message" id="copyMessage">페이지 URL이 복사되었습니다!</div> -->
        <div class="list-wrap">
          <table>
            <tr>
              <td>진행 멤버</td>
              <td th:text="${showDetail.getRecruitCount()} + '명'">4명</td>
              <td>진행 방식</td>
              <td th:text="${showDetail.getProjectProcess()}">온라인</td>
            </tr>
            <tr>
              <td>모집 분야</td>
              <td class="skill-td">
                <span class="work top" th:each="role : ${showDetail.getRecruitRoles()}" th:text="${role}">전체</span>
              </td>
              <td>수행 목적</td>
              <td th:text="${showDetail.getProjectPurpose()}">포트폴리오</td>
            </tr>
            <tr>
              <td>시작 날짜</td>
              <td th:text="${showDetail.getCreatedAt()}">2024.06.09</td>
              <td>종료 날짜</td>
              <td th:text="${showDetail.getModifiedShow()}">2024.06.30</td>
            </tr>
            <tr>
              <td>참여 시간</td>
              <td th:if="${showDetail.getProjectTime() == 1}">매주 4시간 이하</td>
              <td th:if="${showDetail.getProjectTime() == 2}">4시간 ~ 10시간</td>
              <td th:if="${showDetail.getProjectTime() == 3}">10시간 이상</td>
              <td>기술 스택</td>
              <td>
                <ul class="skill">
                  <li th:each="skill : ${showDetail.getSkills()}">
                    <th:block th:switch="${skill}">
                      <img th:case="'AWS'" src="/img/aws.svg" alt="AWS"/>
                      <img th:case="'Docker'" src="/img/docker.svg" alt="Docker"/>
                      <img th:case="'Figma'" src="/img/figma.svg" alt="Figma"/>
                      <img th:case="'Flutter'" src="/img/flutter.svg" alt="Flutter"/>
                      <img th:case="'Git'" src="/img/git.svg" alt="Git"/>
                      <img th:case="'Java'" src="/img/java.svg" alt="Java"/>
                      <img th:case="'JavaScript'" src="/img/javascript.svg" alt="JavaScript"/>
                      <img th:case="'Jest'" src="/img/jest.svg" alt="Jest"/>
                      <img th:case="'Kotlin'" src="/img/kotlin.svg" alt="Kotlin"/>
                      <img th:case="'MongoDb'" src="/img/mongodb.svg" alt="MongoDb"/>
                      <img th:case="'MySQL'" src="/img/mysql.svg" alt="MySQL"/>
                      <img th:case="'Nodejs'" src="/img/nodejs.svg" alt="Nodejs"/>
                      <img th:case="'php'" src="/img/php.svg" alt="php"/>
                      <img th:case="'Python'" src="/img/python.svg" alt="Python"/>
                      <img th:case="'React'" src="/img/react.svg" alt="React"/>
                      <img th:case="'ReactNative'" src="/img/reactnative.svg" alt="ReactNative"/>
                      <img th:case="'Spring'" src="/img/spring.svg" alt="Spring"/>
                      <img th:case="'Svelte'" src="/img/svelte.svg" alt="Svelte"/>
                      <img th:case="'TypeScript'" src="/img/typescript.svg" alt="TypeScript"/>
                      <img th:case="'Vue'" src="/img/vue.svg" alt="Vue"/>
                      <!-- TODO : 추가적인 스킬에 대한 case를 여기에 추가 -->
                      <span th:case="*">[[${skill}]]</span>
                    </th:block>
                  </li>
                </ul>
              </td>
            </tr>
          </table>
        </div>
        <div class="pj-intro">
          <h2 class="title-contents">프로젝트 소개</h2>
          <p class="content bottom" th:text="${showDetail.getProjectInfo()}">
            내용이다 바보야
          </p>
        </div>
      </div>
      <div class="show-btn">
        <button class="like" th:onclick="|projectLike(${showDetail.getId()})|">
          <i class="fa-regular fa-thumbs-up"></i>
          <span id="liveLike">
            <th:block th:text="${showDetail.getLikes()}"> 4개</th:block>
          </span>
        </button>
        <a th:href="@{/project/show}">
          <button class="list"><i class="fa-solid fa-list-ul"></i>목록</button>
        </a>
      </div>
    </div>
    <div class="right-box">
      <div class="profile-box">
        <img th:src="@{/upload/{url}(url=${showDetail.getOwnerInfo().getProfileImageUrl()})}" alt="프로필이미지">
        <div class="right-tag">
          <!--/*@thymesVar id="member" type=""*/-->
          <span class="work right" th:text="${showDetail.getOwnerInfo().getPosition()}">백엔드</span>
          <span class="career right" th:if="${showDetail.getOwnerInfo().getCareer() == 1}">학생/취준생</span>
          <span class="career right" th:if="${showDetail.getOwnerInfo().getCareer() == 2}">신입</span>
          <span class="career right" th:if="${showDetail.getOwnerInfo().getCareer() == 3}">1~3년차</span>
          <span class="career right" th:if="${showDetail.getOwnerInfo().getCareer() == 4}">3~5년차</span>
          <span class="career right" th:if="${showDetail.getOwnerInfo().getCareer() == 5}">5년이상</span>
        </div>
        <h3 th:text="${showDetail.getOwnerInfo().getUsername()}">👑 이윤지</h3>
      </div>
      <th:block th:if="${session.loginMember == null}">
        <!-- 북마크 안했을때 -->
        <button style="border: 1px solid var(--main-color); color: var(--main-color); background-color: white;"
                class="right-btn keep" th:onclick="|projectBookmark(${showDetail.getId()})|">
          <i class="fa-regular fa-bookmark" style="color: var(--main-color);"></i>북마크
        </button>
      </th:block>
      <th:block th:if="${session.loginMember != null}">
        <!-- 북마크 안했을때 -->
        <button th:if="${isBookmark == 0}" style="border: 1px solid var(--main-color); color: var(--main-color); background-color: white;"
                class="right-btn keep" th:onclick="|projectBookmark(${showDetail.getId()})|">
          <i class="fa-regular fa-bookmark" style="color: var(--main-color);"></i>북마크
        </button>
        <!-- 북마크 했을때 -->
        <button th:if="${isBookmark == 1}" style="border: 1px solid var(--main-color); color: white; background-color: var(--main-color);"
                class="right-btn keep" th:onclick="|projectBookmark(${showDetail.getId()})|">
          <i class="fa-regular fa-bookmark" style="color: white;"></i>북마크
        </button>
      </th:block>
      <th:block th:if="${showDetail.getGithubLink() == null}"><a style="display:none;" th:href="@{/{github}(github=${showDetail.getGithubLink()})}"><button class="right-btn github"><i class="fa-brands fa-github"></i>깃허브</button></a></th:block>
      <th:block th:if="${showDetail.getGithubLink() != null}"><a th:href="@{/{github}(github=${showDetail.getGithubLink()})}"><button class="right-btn github"><i class="fa-brands fa-github"></i>깃허브</button></a></th:block>
      <div class="edit-btn" th:if="${session.loginMember != null && session.loginMember.getId()==showDetail.getOwnerId()}">
        <a th:href="@{/project/show_edit/{projectId}(projectId=${showDetail.getId()})}">
          <button class="right-btn mod_btn">수정</button>
        </a>
        <button class="right-btn del_btn open-modal">삭제</button>
      </div>
    </div>
    <!-- 모달창 -->
    <div class="modal-bg">
    </div>
    <div class="modal">
      <div class="modal-header">
        <a href="#" class="close-modal"><i class="fa-solid fa-xmark"></i></a>
      </div>
      <h3>게시글을 삭제하시겠습니까?</h3>
      <p>삭제 후에는 게시글을 되돌릴 수 없습니다.</p>
      <div class="button-wrap">
        <button class="close-modal-back">돌아가기</button>
        <button class="submit-modal" type="submit" th:onclick="|ajaxDelete(${showDetail.getId()})|">삭제하기</button>
      </div>
    </div>
<!--    <div class="modal-bg bg02">-->
<!--    </div>-->
<!--    <div class="modal02">-->
<!--      <div class="modal-header">-->
<!--        <a href="#" class="close-modal02"><i class="fa-solid fa-xmark"></i></a>-->
<!--      </div>-->
<!--      <h3>게시글을 삭제하시겠습니까?</h3>-->
<!--      <p>삭제 후에는 게시글을 되돌릴 수 없습니다.</p>-->
<!--      <div class="button-wrap" >-->
<!--        <button class="close-modal02-back">돌아가기</button>-->
<!--        <button class="submit-modal" type="submit" th:onclick="|ajaxDelete(${showDetail.getId()})|">삭제하기</button>-->
<!--      </div>-->
<!--    </div>-->
  </div>
</main>
<!-- 로그인 유무 -->
<th:block th:if="${session.loginMember != null}"><div class="loginMember" th:text="${session.loginMember.getId()}" style="display: none"></div></th:block>
<th:block th:if="${session.loginMember == null}"><div class="loginMember" style="display: none">0</div></th:block>
<footer>
  <th:block th:replace="~{fragment/footer}"></th:block>
</footer>
<script>
    // 좋아요 수 실시간으로 증감하는 로직(비동기 방식)
  function projectLike(projectId){
    let memberId = document.querySelector(".loginMember").textContent;
    let data = {};
    data.memberId = memberId;
    data.projectId = projectId;
    // data.key = value -> data{ key: value}

    if(memberId == 0)   // 로그인이 되어있지 않을 때
      alert("로그인이 필요합니다 !");
    else{       // 로그인이 되어있을 때
      // 좋아요 로직 시작
      $.ajax({
        type : "POST",
        url : "/api/like",
        data : JSON.stringify(data),
        contentType : "application/json; charset=utf-8",
        dataType : "json"
      }).done(res=>{ // HttpStatus 200번대(로드 성공)
        let likeCount = res.data;// 서버에서 최종 세팅된 좋아요수

        $("#topLiveLike").text(likeCount+'개')
        $("#liveLike").text(likeCount); // Id값이 liveLike 인 태그의 자식 요소에 text 값을 삽입

      }).fail(error=>{ // HttpStatus 200번대가 아닐때(로드 실패)
        console.log(error);
        alert(error.responseJSON.msg);
      });
    }
  }

    // 북마크 눌렀을 때 실시간으로 색이 변하게 하는 로직(북마크 중이면 main_color, 북마크를 안하면 색 없음 / 비동기 방식)
    function projectBookmark(projectId){
      let memberId = document.querySelector(".loginMember").textContent;
      console.log("memberId:", memberId); // memberId가 올바르게 설정되었는지 확인
      let data = {};
      data.memberId = memberId;
      data.projectId = projectId;
      // data.key = value -> data{ key: value}

      if(memberId == 0)   // 로그인이 되어있지 않을 때
        alert("로그인이 필요합니다 !");
      else{       // 로그인이 되어있을 때
        // 북마크 로직 시작
        $.ajax({
          type : "POST",
          url : "/api/keep",
          data : JSON.stringify(data),
          contentType : "application/json; charset=utf-8",
          dataType : "json"
        }).done(res=>{ // HttpStatus 200번대(로드 성공)
          console.log("성공");

          if (res.data == 1) { // 서버 응답에 북마크 상태 포함한다고 가정
            // 북마크가 추가된 경우
            $(".keep").css("background-color", "var(--main-color)");
            $(".keep").css("border", "1px solid var(--main-color)");
            $(".keep").css("color", "white");
            $(".keep").html('<i class="fa-regular fa-bookmark" style="color: white;"></i> 북마크');
            alert("북마크가 추가되었습니다!");
          } else if (res.data == 0) {
            // 북마크가 취소된 경우
            $(".keep").css("background-color", "white");
            $(".keep").css("color", "var(--main-color)");
            $(".keep").css("border", "1px solid var(--main-color)");
            $(".keep").html('<i class="fa-regular fa-bookmark" style="color: var(--main-color);"></i> 북마크');

            alert("북마크가 취소되었습니다!");
          }

        }).fail(error=>{ // HttpStatus 200번대가 아닐때(로드 실패)

          console.log(error);
          alert("실패..");
        });
      }
    }

    document.querySelector(".open-modal").addEventListener("click", function () {
        document.querySelector(".modal-bg").classList.add("visible");
        document.querySelector(".modal").classList.add("visible");
    });

    document.querySelector(".close-modal").addEventListener("click", function () {
        document.querySelector(".modal-bg").classList.remove("visible");
        document.querySelector(".modal").classList.remove("visible");
    });

    document.querySelector(".close-modal-back").addEventListener("click", function () {
        document.querySelector(".modal-bg").classList.remove("visible");
        document.querySelector(".modal").classList.remove("visible");
    });

    document.addEventListener("click", function (event) {
        if (
            !event.target.closest(".modal, .open-modal, .open-modal02, .modal02")
        ) {
            document.querySelector(".modal").classList.remove("visible");
            document.querySelector(".modal-bg").classList.remove("visible");

            document.body.classList.remove("modal-open");
        }
    });

    // 프로젝트 자랑 삭제
    function ajaxDelete(projectId) {
      $.ajax({
        type: "DELETE",
        url: "/api/show/" + projectId,
        contentType: "application/json; charset=utf-8",
        dataType: "json"
      }).done(res => { // HTTP 상태 코드 200번대일 때 호출됨
        console.log("성공:", res);
        alert("게시글이 성공적으로 삭제되었습니다."); // 서버에서 반환된 메시지 표시
        window.location.replace(`/project/show`);
      }).fail(error => { // HTTP 상태 코드 200번대가 아닐 때 호출됨
        alert("게시글 삭제를 실패했습니다. 다시 시도해주세요."); // 서버에서 반환된 메시지 대신 고정 메시지 표시
      });
    }
</script>
</body>
</html>
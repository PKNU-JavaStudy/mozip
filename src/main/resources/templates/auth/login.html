<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>모집(mo.zip) - 로그인</title>
  <!-- font awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A=="
        crossorigin="anonymous" referrerpolicy="no-referrer"/>
  <!-- 직접 구현한 CSS -->
  <link rel="stylesheet" th:href="@{/css/reset.css}"/>
  <link rel="stylesheet" th:href="@{/css/common.css}"/>
  <link rel="stylesheet" th:href="@{/css/user.css}"/>

  <script th:src="@{/js/common.js}"></script>
  <script defer th:src="@{/js/join_effect.js}"></script>
  <!--  kakaoLogin  -->
  <script src="https://t1.kakaocdn.net/kakao_js_sdk/2.7.2/kakao.min.js"
          integrity="sha384-TiCUE00h649CAMonG018J2ujOgDKW/kVWlChEuu4jK2vxfAAD0eZxzCKakxg55G4" crossorigin="anonymous"></script>
  <!-- favicon -->
  <link rel="icon" th:href="@{/img/favicon.ico}">
</head>
<body>
<header id="header">
  <th:block th:replace="~{fragment/header}"></th:block>
</header>
<main>
  <div class="wrap flex user-title">
    <h1>로그인</h1>
    <form class="submit-box" action="/auth/login" method="post">
      <div class="input-group">
        <h2 for="email">이메일</h2>
        <input type="email" id="email" name="email" placeholder="mozip@mozip.com" required>
      </div>
      <div class="input-group">
        <h2 for="password">비밀번호</h2>
        <input type="password" id="password" name="password" placeholder="비밀번호를 입력하세요." minlength="5" required>
      </div>
      <div class="inputLogin">
        <input type="submit" value="로그인" class="inputLogin">
      </div>
      <div class="separator">또는</div>
      <div class="kakaoLogin">
        <input type="submit" value="카카오 로그인" class="kakao">
      </div>

<!--      <div class="kakaoLogin">-->
<!--        <a id="kakao-login-btn" href="javascript:loginWithKakao()">-->
<!--          <img src="https://k.kakaocdn.net/14/dn/btroDszwNrM/I6efHub1SN5KCJqLm1Ovx1/o.jpg" width="222"-->
<!--               alt="카카오 로그인 버튼" />-->
<!--        </a>-->
<!--      </div>-->
<!--      <p id="token-result"></p>-->
<!--      <button class="api-btn" onclick="requestUserInfo()">사용자 정보 가져오기</button>-->
      <div class="submit">아직 회원이 아니신가요??
        <span><a th:href="@{/auth/join}">가입하기</a></span>
        <br>
      </div>
      <div class="forgot">
        <ul>
          <li><a th:href="@{/auth/findId}">아이디 찾기</a></li>
          <li><a th:href="@{/auth/findPw}">비밀번호 찾기</a></li>
        </ul>
      </div>
    </form>
  </div>
</main>
<footer>
  <th:block th:replace="~{fragment/footer}"></th:block>
</footer>
</body>
<script>
  // SDK 초기화
  Kakao.init('517507b2dbde5f2a043dea16af99003e');

  //로그인 리다이렉트
  function loginWithKakao() {
    Kakao.Auth.authorize({
      redirectUri: 'http://localhost:8082/auth/login'
    });
  }

  // 사용자 정보 서버로 전송
  function requestUserInfo() {
    Kakao.API.request({
      url: '/v2/user/me'
    }).then(function(res) {
      sendUserInfoToServer(res);
    }).catch(function(err) {
      alert('사용자 정보 요청 실패 :  ' + JSON.stringify(err));
    });
  }

  //서버에서 사용자 정보 받아오기
  function sendUserInfoToServer(userInfo) {
    fetch('/auth/kakao/userinfo', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(userInfo)
    }).then(response => response.json())
            .then(data => {
              if (data.success) {
                window.location.reload();
              } else {
                alert('서버로부터 사용자정보를 받아오는데 실패했습니다.');
              }
            });
  }

  // 쿠키
  function getCookie(name) {
    var parts = document.cookie.split(name + '=');
    if (parts.length === 2) { return parts[1].split(';')[0]; }
  }

  function displayToken() {
    var token = getCookie('authorize-access-token');
    if (token) {
      Kakao.Auth.setAccessToken(token);
      document.querySelector('#token-result').innerText = '로그인 성공 !';
      document.querySelector('button.api-btn').style.visibility = 'visible';
    }
  }

  // 토큰 받아오기
  function getAccessToken() {
    const params = new URLSearchParams(window.location.search);
    const code = params.get('code');

    if (code) {
      fetch('https://kauth.kakao.com/oauth/token', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({
          grant_type: 'authorization_code',
          // API키 입력하는 곳
          client_id: '5892cc9474d5fb5b751afedea47f58be',
          redirect_uri: 'http://localhost:8082/auth/login',
          code: code
        })
      })
              .then(response => response.json())
              .then(data => {
                if (data.access_token) {
                  Kakao.Auth.setAccessToken(data.access_token);
                  document.cookie = 'authorize-access-token=' + data.access_token;
                  displayToken();
                } else {
                  alert('토큰을 받아오기 실패 :  ' + JSON.stringify(data));
                }
              })
              .catch(error => {
                alert('Error during token fetch: ' + error);
              });
    }
  }

  // 초기 액세스 토큰 설정
  getAccessToken();
  displayToken();
</script>
</html>